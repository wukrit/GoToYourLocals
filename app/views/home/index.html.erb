<h1>Locals Tracker</h1>

<% if user_signed_in? %>
<div class="mb-4">
  <div class="btn-group" role="group">
    <%= button_to "Sync Tournaments Only", sync_user_tournaments_path, class: "btn btn-outline-primary" %>
    <%= button_to "Sync All (Tournaments, Events & Matches)", sync_all_path, class: "btn btn-primary" %>
  </div>
</div>

<% if current_user.tournaments.any? && current_user.events.any? %>
<div class="mb-4">
  <div class="card">
    <div class="card-header">
      <h4>Select Game</h4>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <%= form_tag root_path, method: :get, class: "form-inline" do %>
          <div class="input-group mb-3">
            <%= select_tag :game, options_for_select(@games, @selected_game), class: "form-control" %>
            <div class="input-group-append">
              <%= submit_tag "View Results", class: "btn btn-primary" %>
            </div>
          </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<% if @selected_game.present? %>
<%
        # Find all events for the selected game using our normalized names
        game_events = filter_events_by_game(current_user.events, @selected_game)

        # Get the event IDs to use in subsequent queries
        event_ids = game_events.map(&:id)

        # Use the event IDs to get properly eager-loaded events
        game_events_with_associations = Event.includes(
          :tournament,
          :user_event_participations,
          matches: [:users, :user_match_participations]
        ).where(id: event_ids)

        # Group these events by tournament
        tournaments_with_events = game_events_with_associations.group_by(&:tournament)

        # Sort tournaments by date
        sorted_tournaments = tournaments_with_events.keys.sort_by { |t| t.start_at || Time.new(1970) }.reverse
      %>

<div class="card">
  <div class="card-header">
    <h4><%= @selected_game %> Tournament Results</h4>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Tournament</th>
            <th>Date</th>
            <th>Record</th>
            <th>Placement</th>
            <th>Wins</th>
            <th>Losses</th>
          </tr>
        </thead>
        <tbody>
          <% sorted_tournaments.each do |tournament| %>
          <% events = tournaments_with_events[tournament] %>
          <% events.each do |event| %>
          <%
                      # Get user's participation in this event
                      participation = current_user.user_event_participations.find_by(event: event)

                      # Get matches for this event
                      all_matches = event.matches.includes(user_match_participations: :user)

                      # Get user's matches
                      user_matches = all_matches.joins(:user_match_participations)
                                      .where(user_match_participations: { user_id: current_user.id })

                      # Get wins and losses
                      wins = user_matches.joins(:user_match_participations)
                              .where(user_match_participations: { user_id: current_user.id, is_winner: true })
                              .distinct

                      losses = user_matches.joins(:user_match_participations)
                               .where(user_match_participations: { user_id: current_user.id, is_winner: false })
                               .distinct

                      record = "#{wins.size}-#{losses.size}"
                    %>
          <tr>
            <td><%= tournament.name %></td>
            <td><%= tournament.start_at&.strftime("%b %d, %Y") || "Unknown" %></td>
            <td><strong><%= record %></strong></td>
            <td><%= participation&.final_placement || "N/A" %></td>
            <td>
              <% if wins.any? %>
              <ul class="list-unstyled">
                <% wins.each do |win| %>
                <%
                          # Find opponent
                          opponent_participation = win.user_match_participations
                                                    .where.not(user_id: current_user.id)
                                                    .first
                          opponent = opponent_participation&.user
                        %>
                <li>
                  <% if opponent %>
                  <strong><%= opponent.tag || "Unknown" %></strong>
                  <% else %>
                  <strong>Unknown Opponent</strong>
                  <% end %>
                  <small class="text-muted"><%= win.display_score || win.full_round_text || "Win" %></small>
                </li>
                <% end %>
              </ul>
              <% else %>
              None
              <% end %>
            </td>
            <td>
              <% if losses.any? %>
              <ul class="list-unstyled">
                <% losses.each do |loss| %>
                <%
                          # Find opponent
                          opponent_participation = loss.user_match_participations
                                                     .where.not(user_id: current_user.id)
                                                     .first
                          opponent = opponent_participation&.user
                        %>
                <li>
                  <% if opponent %>
                  <strong><%= opponent.tag || "Unknown" %></strong>
                  <% else %>
                  <strong>Unknown Opponent</strong>
                  <% end %>
                  <small class="text-muted"><%= loss.display_score || loss.full_round_text || "Loss" %></small>
                </li>
                <% end %>
              </ul>
              <% else %>
              None
              <% end %>
            </td>
          </tr>
          <% end %>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>
<% end %>
<% else %>
<div class="alert alert-info">
  You haven't synced any tournaments yet. Click the button above to sync your tournaments from Start.gg.
</div>
<% end %>
<% else %>
<div class="jumbotron">
  <h2>Track your tournament results</h2>
  <p>Sign in with Start.gg to sync your tournament history and track your performance.</p>
  <p><%= link_to "Sign in with Start.gg", user_startgg_omniauth_authorize_path, class: "btn btn-lg btn-primary" %></p>
</div>
<% end %>