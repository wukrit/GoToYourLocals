<%
  # Initialize the view model
  view_model = GameResultsViewModel.new(current_user, selected_game, date_range: date_range, tournament_type: tournament_type)
%>

<h3 class="tournament-results-header"><%= selected_game %> Tournament Results</h3>

<div class="overall-record-panel">
  <div class="record-stats">
    <div class="record-stat">
      <span class="stat-label">Overall Record (<%= view_model.date_range_text %>, <%= view_model.tournament_type_text %>)</span>
      <span class="stat-value"><%= view_model.total_wins %>-<%= view_model.total_losses %></span>
    </div>
    <div class="record-stat">
      <span class="stat-label">Win Rate</span>
      <span class="stat-value"><%= view_model.win_percentage %>%</span>
    </div>
    <div class="record-stat">
      <span class="stat-label">Total Matches</span>
      <span class="stat-value"><%= view_model.total_matches %></span>
    </div>
  </div>
  <div class="record-visual">
    <div class="win-bar" style="width: <%= view_model.win_percentage %>%"></div>
    <div class="loss-bar" style="width: <%= 100 - view_model.win_percentage %>%"></div>
  </div>
</div>

<% if view_model.sorted_tournaments.any? %>
<div class="table-container">
  <table>
    <thead>
      <tr>
        <th>Tournament</th>
        <th>Date</th>
        <th>Type</th>
        <th>Record</th>
        <th>Placement</th>
        <th>Wins <span class="column-heading-badge wins-badge">W</span></th>
        <th>Losses <span class="column-heading-badge losses-badge">L</span></th>
      </tr>
    </thead>
    <tbody>
      <% view_model.sorted_tournaments.each do |tournament| %>
      <% events = view_model.get_tournament_events(tournament) %>
      <% events.each do |event| %>
      <%
            # Get user's participation in this event
            participation = view_model.get_user_participation(event)

            # Get matches for this event
            all_matches = view_model.get_event_matches(event)

            # Get user's matches
            user_matches = view_model.get_user_matches(all_matches)

            # Get wins and losses
            wins = view_model.get_wins(user_matches)
            losses = view_model.get_losses(user_matches)

            record = view_model.get_record(wins, losses)
          %>
      <tr>
        <td><%= tournament.name %></td>
        <td><%= tournament.start_at&.strftime("%b %d, %Y") || "Unknown" %></td>
        <td>
          <% if tournament.is_online %>
          <span class="tournament-type tournament-online">Online</span>
          <% else %>
          <span class="tournament-type tournament-offline">Offline</span>
          <% end %>
        </td>
        <td><span class="record"><%= record %></span></td>
        <td><%= participation&.final_placement&.ordinalize || "N/A" %></td>
        <td class="wins-column">
          <% if wins.any? %>
          <ul>
            <% wins.each do |win| %>
            <li>
              <div class="player-match win">
                <div class="player-name"><%= view_model.get_opponent(win) %></div>
                <div class="match-score"><%= win.display_score || win.full_round_text || "Win" %></div>
              </div>
            </li>
            <% end %>
          </ul>
          <% else %>
          None
          <% end %>
        </td>
        <td class="losses-column">
          <% if losses.any? %>
          <ul>
            <% losses.each do |loss| %>
            <li>
              <div class="player-match loss">
                <div class="player-name"><%= view_model.get_opponent(loss) %></div>
                <div class="match-score"><%= loss.display_score || loss.full_round_text || "Loss" %></div>
              </div>
            </li>
            <% end %>
          </ul>
          <% else %>
          None
          <% end %>
        </td>
      </tr>
      <% end %>
      <% end %>
    </tbody>
  </table>
</div>
<% else %>
<div class="alert alert-info">
  No tournament results found for <%= selected_game %> within the selected date range and tournament type.
</div>
<% end %>